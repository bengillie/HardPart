"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var timetable_model_1 = require("~/model/timetable.model");
var appvalues_service_1 = require("~/service/appvalues.service");
var homework_service_1 = require("~/service/homework.service");
var logging_service_1 = require("~/service/logging.service");
var timetable_service_1 = require("../service/timetable.service");
var TimetableComponent = /** @class */ (function () {
    function TimetableComponent(appValuesService, homeworkService, loggingService, router, timetableService) {
        this.appValuesService = appValuesService;
        this.homeworkService = homeworkService;
        this.loggingService = loggingService;
        this.router = router;
        this.timetableService = timetableService;
        this.subscriptions = [];
        this.breakPeriodLabel = "";
        this.homeworkIcon = "";
        this.lessonDate = new Date();
        this.startDate = new Date();
        this.endDate = new Date();
        this.allLessons = [];
        this.lessonsForDate = [];
        this.allPeriods = [];
        this.periodsForDate = [];
        this.allHomeworks = [];
        this.allDueHomeworks = [];
        this.current = false;
        this.hasLesson = true;
        this.isDueLesson = false;
        this.isLoading = true;
        this.lastLesson = false;
        this.showDetails = true;
    }
    TimetableComponent.prototype.ngOnInit = function () {
        this.loggedInUser = this.appValuesService.getLoggedInUser();
        this.startDate.setDate(this.startDate.getDate() - (this.startDate.getDay() - 7));
        this.endDate.setDate(this.endDate.getDate() - (this.endDate.getDay() + 7));
        this.getAllHomework();
        this.getLessons();
        this.getPeriods();
    };
    TimetableComponent.prototype.ngOnDestroy = function () {
        if (this.subscriptions) {
            for (var _i = 0, _a = this.subscriptions; _i < _a.length; _i++) {
                var subscription = _a[_i];
                subscription.unsubscribe();
            }
        }
    };
    TimetableComponent.prototype.getAllHomework = function () {
        var _this = this;
        this.subscriptions.push(this.homeworkService.getStudentHomework(this.loggedInUser.id)
            .subscribe(function (homework) {
            _this.allHomeworks = homework;
        }));
    };
    TimetableComponent.prototype.getBreak = function (lesson) {
        var breakTime = timetable_model_1.Break;
        var regexp = new RegExp('B');
        var name = this.getPeriodNameForLesson(lesson);
        if ((new Date(lesson.startDate).getHours() < 12) && regexp.test(name)) {
            this.showDetails = false;
            this.breakPeriodLabel = breakTime.amBreak;
            return true;
        }
        else if ((new Date(lesson.startDate).getHours() >= 12) && regexp.test(name)) {
            this.showDetails = false;
            this.breakPeriodLabel = breakTime.pmBreak;
            return true;
        }
        else {
            this.showDetails = true;
            return false;
        }
    };
    TimetableComponent.prototype.getCurrentLesson = function (lesson) {
        var today = new Date();
        if ((today >= new Date(lesson.startDate)) && (today <= new Date(lesson.endDate))) {
            this.current = true;
            return true;
        }
        else {
            this.current = false;
            return false;
        }
    };
    TimetableComponent.prototype.getHomeworkDueDate = function (lesson) {
        var dueHomework = this.allHomeworks.find(function (h) {
            return h.subject == lesson.subject;
        });
        if (dueHomework != undefined) {
            this.allDueHomeworks.push(dueHomework);
            var isDue = this.homeworkService.isNearDueDate(dueHomework);
            if (isDue === true) {
                this.isDueLesson = true;
                this.homeworkIcon = String.fromCharCode(0xe91f);
                return true;
            }
        }
        return false;
    };
    TimetableComponent.prototype.getLessons = function () {
        var _this = this;
        this.isLoading = true;
        this.subscriptions.push(this.timetableService.getLessons()
            .subscribe(function (lessons) {
            lessons = lessons.sort(function (obj1, obj2) {
                return new Date(obj1.startDate).getHours() - new Date(obj2.startDate).getHours();
            });
            _this.allLessons = lessons;
            _this.getLessonsForDate(_this.lessonDate);
            _this.isLoading = false;
        }));
    };
    TimetableComponent.prototype.getLessonsForDate = function (date) {
        if (!this.allLessons) {
            this.lessonsForDate = [];
            return;
        }
        this.lessonsForDate = this.allLessons.filter(function (l) { return new Date(l.startDate).toDateString() === date.toDateString(); });
        this.getTotalLesson();
    };
    TimetableComponent.prototype.getPeriods = function () {
        var _this = this;
        this.isLoading = true;
        this.subscriptions.push(this.timetableService.getPeriods(new Date(this.startDate), new Date(this.endDate))
            .subscribe(function (p) {
            _this.allPeriods = p;
            _this.isLoading = false;
        }));
    };
    TimetableComponent.prototype.getPeriodNameForLesson = function (lesson) {
        var name = "";
        var startLessonDay = new Date(lesson.startDate).getDay();
        var startLessonHour = new Date(lesson.startDate).getHours();
        var startLessonMinute = new Date(lesson.startDate).getMinutes();
        var endLessonDay = new Date(lesson.endDate).getDay();
        var endLessonHour = new Date(lesson.endDate).getHours();
        var endLessonMinute = new Date(lesson.endDate).getMinutes();
        var period = this.allPeriods.find(function (p) {
            return new Date(p.startDate).getDay() == startLessonDay &&
                new Date(p.startDate).getHours() == startLessonHour &&
                new Date(p.startDate).getMinutes() == startLessonMinute &&
                new Date(p.endDate).getDay() == endLessonDay &&
                new Date(p.endDate).getHours() == endLessonHour &&
                new Date(p.endDate).getMinutes() == endLessonMinute;
        });
        if (period) {
            name = period.name;
        }
        return name;
    };
    TimetableComponent.prototype.getSubjectColour = function (lesson) {
        var subject = timetable_model_1.Subject;
        var color = "";
        switch (lesson.subject) {
            case subject.art: {
                return color = "#8B0000";
            }
            case subject.computing: {
                return color = "#8B4513";
            }
            case subject.design: {
                return color = "#808000";
            }
            case subject.english: {
                return color = "#2ECCFA";
            }
            case subject.geography: {
                return color = "#FA58F4";
            }
            case subject.history: {
                return color = "#04B404";
            }
            case subject.languages: {
                return color = "#BF00FF";
            }
            case subject.math: {
                return color = "#FF8000";
            }
            case subject.music: {
                return color = "#642EFE";
            }
            case subject.pe: {
                return color = "#FFFF00";
            }
            case subject.reg: {
                return color = "#086A87";
            }
            case subject.science: {
                return color = "#FF0000";
            }
        }
    };
    TimetableComponent.prototype.getTotalLesson = function () {
        if (this.lessonsForDate.length === 0) {
            this.hasLesson = false;
        }
        else {
            this.hasLesson = true;
        }
    };
    TimetableComponent.prototype.onLeftSwipeClick = function () {
        var oneWeekPrev = new Date();
        oneWeekPrev.setDate(oneWeekPrev.getDate() - (oneWeekPrev.getDay() + 6));
        this.loggingService.log("swipe left");
        this.lessonDate = new Date(this.lessonDate.setDate(this.lessonDate.getDate() - 1));
        if (oneWeekPrev < this.lessonDate) {
            this.getLessonsForDate(this.lessonDate);
            this.lastLesson = false;
        }
        else {
            this.loggingService.log("Last lesson for the previous week");
            this.lastLesson = true;
        }
    };
    TimetableComponent.prototype.onRightSwipeClick = function () {
        var twoWeeksFuture = new Date();
        twoWeeksFuture.setDate(twoWeeksFuture.getDate() - (twoWeeksFuture.getDay() - 20));
        this.loggingService.log("swipe right");
        this.lessonDate = new Date(this.lessonDate.setDate(this.lessonDate.getDate() + 1));
        if (twoWeeksFuture >= this.lessonDate) {
            this.getLessonsForDate(this.lessonDate);
            this.lastLesson = false;
        }
        else {
            this.loggingService.log("Last lesson for the next two weeks");
            this.lastLesson = true;
        }
    };
    TimetableComponent.prototype.onSwipe = function (args) {
        if (this.lastLesson === false) {
            this.loggingService.log("timetable swipe direction" + args.direction.toString());
            if (args.direction === 1) {
                this.onLeftSwipeClick();
            }
            else {
                this.onRightSwipeClick();
            }
        }
        else {
            this.loggingService.log("Lock Timetable swipe");
        }
    };
    TimetableComponent.prototype.onTapHomework = function (lesson) {
        var homework = this.allDueHomeworks.find(function (h) {
            return h.subject == lesson.subject;
        });
        this.router.navigate(["/homeworkdetails/" + homework.id]);
    };
    TimetableComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'ns-timetable',
            templateUrl: './timetable.component.html',
            styleUrls: ['./timetable.component.less']
        }),
        __metadata("design:paramtypes", [appvalues_service_1.AppValuesService,
            homework_service_1.HomeworkService,
            logging_service_1.LoggingService,
            router_1.Router,
            timetable_service_1.TimetableService])
    ], TimetableComponent);
    return TimetableComponent;
}());
exports.TimetableComponent = TimetableComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXRhYmxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRpbWV0YWJsZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkU7QUFDM0UsMENBQXlDO0FBS3pDLDJEQUF5RDtBQUd6RCxpRUFBK0Q7QUFDL0QsK0RBQTZEO0FBQzdELDZEQUEyRDtBQUMzRCxrRUFBZ0U7QUFTaEU7SUE0QkksNEJBQ1ksZ0JBQWtDLEVBQ2xDLGVBQWdDLEVBQ2hDLGNBQThCLEVBQzlCLE1BQWMsRUFDZCxnQkFBa0M7UUFKbEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBaEN0QyxrQkFBYSxHQUFvQixFQUFFLENBQUM7UUFFNUMscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQ3RCLGlCQUFZLEdBQUcsRUFBRSxDQUFDO1FBSWxCLGVBQVUsR0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQzlCLGNBQVMsR0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQzdCLFlBQU8sR0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRTNCLGVBQVUsR0FBYSxFQUFFLENBQUM7UUFDMUIsbUJBQWMsR0FBYSxFQUFFLENBQUM7UUFFOUIsZUFBVSxHQUFhLEVBQUUsQ0FBQztRQUMxQixtQkFBYyxHQUFhLEVBQUUsQ0FBQztRQUU5QixpQkFBWSxHQUFlLEVBQUUsQ0FBQztRQUM5QixvQkFBZSxHQUFlLEVBQUUsQ0FBQztRQUVqQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ2hCLGNBQVMsR0FBRyxJQUFJLENBQUM7UUFDakIsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFDcEIsY0FBUyxHQUFHLElBQUksQ0FBQztRQUNqQixlQUFVLEdB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Q3BELENBQUM7SUFDTCxDQUFDO0lBRUQsMENBQWEsR0FBYixVQUFjLE1BQWM7UUFDeEIsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBQSxDQUFDO1lBQ3hDLE9BQUEsQ0FBQyxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsT0FBTztRQUEzQixDQUEyQixDQUM5QixDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxzQkFBb0IsUUFBUSxDQUFDLEVBQUksQ0FBQyxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQTVSUSxrQkFBa0I7UUFOOUIsZ0JBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQixRQUFRLEVBQUUsY0FBYztZQUN4QixXQUFXLEVBQUUsNEJBQTRCO1lBQ3pDLFNBQVMsRUFBRSxDQUFDLDRCQUE0QixDQUFDO1NBQzVDLENBQUM7eUNBOEJnQyxvQ0FBZ0I7WUFDakIsa0NBQWU7WUFDaEIsZ0NBQWM7WUFDdEIsZUFBTTtZQUNJLG9DQUFnQjtPQWpDckMsa0JBQWtCLENBNlI5QjtJQUFELHlCQUFDO0NBQUEsQUE3UkQsSUE2UkM7QUE3UlksZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnXHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTd2lwZUdlc3R1cmVFdmVudERhdGEgfSBmcm9tIFwidWkvZ2VzdHVyZXNcIjtcclxuXHJcbmltcG9ydCB7IExlc3NvbiwgUGVyaW9kIH0gZnJvbSBcIi4uL21vZGVsL3RpbWV0YWJsZS5tb2RlbFwiO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBCcmVhayB9IGZyb20gJ34vbW9kZWwvdGltZXRhYmxlLm1vZGVsJztcclxuaW1wb3J0IHsgVXNlciB9IGZyb20gJ34vbW9kZWwvdXNlci5tb2RlbCc7XHJcblxyXG5pbXBvcnQgeyBBcHBWYWx1ZXNTZXJ2aWNlIH0gZnJvbSAnfi9zZXJ2aWNlL2FwcHZhbHVlcy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgSG9tZXdvcmtTZXJ2aWNlIH0gZnJvbSAnfi9zZXJ2aWNlL2hvbWV3b3JrLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMb2dnaW5nU2VydmljZSB9IGZyb20gJ34vc2VydmljZS9sb2dnaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBUaW1ldGFibGVTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2UvdGltZXRhYmxlLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgSG9tZXdvcmsgfSBmcm9tICd+L21vZGVsL2hvbWV3b3JrLm1vZGVsJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcclxuICAgIHNlbGVjdG9yOiAnbnMtdGltZXRhYmxlJyxcclxuICAgIHRlbXBsYXRlVXJsOiAnLi90aW1ldGFibGUuY29tcG9uZW50Lmh0bWwnLFxyXG4gICAgc3R5bGVVcmxzOiBbJy4vdGltZXRhYmxlLmNvbXBvbmVudC5sZXNzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIFRpbWV0YWJsZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuICAgIHByaXZhdGUgc3Vic2NyaXB0aW9ucyA6IFN1YnNjcmlwdGlvbltdID0gW107XHJcbiAgICBcclxuICAgIGJyZWFrUGVyaW9kTGFiZWwgPSBcIlwiO1xyXG4gICAgaG9tZXdvcmtJY29uID0gXCJcIjtcclxuXHJcbiAgICBsb2dnZWRJblVzZXI6IFVzZXI7XHJcbiAgICBcclxuICAgIGxlc3NvbkRhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgc3RhcnREYXRlOiBEYXRlID0gbmV3IERhdGUoKTtcclxuICAgIGVuZERhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xyXG5cclxuICAgIGFsbExlc3NvbnM6IExlc3NvbltdID0gW107XHJcbiAgICBsZXNzb25zRm9yRGF0ZTogTGVzc29uW10gPSBbXTtcclxuXHJcbiAgICBhbGxQZXJpb2RzOiBQZXJpb2RbXSA9IFtdO1xyXG4gICAgcGVyaW9kc0ZvckRhdGU6IFBlcmlvZFtdID0gW107XHJcblxyXG4gICAgYWxsSG9tZXdvcmtzOiBIb21ld29ya1tdID0gW107XHJcbiAgICBhbGxEdWVIb21ld29ya3M6IEhvbWV3b3JrW10gPSBbXTtcclxuXHJcbiAgICBjdXJyZW50ID0gZmFsc2U7XHJcbiAgICBoYXNMZXNzb24gPSB0cnVlO1xyXG4gICAgaXNEdWVMZXNzb24gPSBmYWxzZTtcclxuICAgIGlzTG9hZGluZyA9IHRydWU7XHJcbiAgICBsYXN0TGVzc29uID0gZmFsc2U7XHJcbiAgICBzaG93RGV0YWlscyA9IHRydWU7XHJcbiAgICAgICAgICAgXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGFwcFZhbHVlc1NlcnZpY2U6IEFwcFZhbHVlc1NlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBob21ld29ya1NlcnZpY2U6IEhvbWV3b3JrU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGxvZ2dpbmdTZXJ2aWNlOiBMb2dnaW5nU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxyXG4gICAgICAgIHByaXZhdGUgdGltZXRhYmxlU2VydmljZTogVGltZXRhYmxlU2VydmljZSxcclxuICAgICkgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7IFxyXG4gICAgICAgIHRoaXMubG9nZ2VkSW5Vc2VyID0gdGhpcy5hcHBWYWx1ZXNTZXJ2aWNlLmdldExvZ2dlZEluVXNlcigpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXJ0RGF0ZS5zZXREYXRlKHRoaXMuc3RhcnREYXRlLmdldERhdGUoKSAtICh0aGlzLnN0YXJ0RGF0ZS5nZXREYXkoKSAtIDcpKTtcclxuICAgICAgICB0aGlzLmVuZERhdGUuc2V0RGF0ZSh0aGlzLmVuZERhdGUuZ2V0RGF0ZSgpIC0gKHRoaXMuZW5kRGF0ZS5nZXREYXkoKSArIDcpKTtcclxuXHJcbiAgICAgICAgdGhpcy5nZXRBbGxIb21ld29yaygpO1xyXG4gICAgICAgIHRoaXMuZ2V0TGVzc29ucygpO1xyXG4gICAgICAgIHRoaXMuZ2V0UGVyaW9kcygpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgc3Vic2NyaXB0aW9uIG9mIHRoaXMuc3Vic2NyaXB0aW9ucylcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWxsSG9tZXdvcmsoKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5ob21ld29ya1NlcnZpY2UuZ2V0U3R1ZGVudEhvbWV3b3JrKHRoaXMubG9nZ2VkSW5Vc2VyLmlkKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgaG9tZXdvcmsgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsSG9tZXdvcmtzID0gaG9tZXdvcms7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QnJlYWsobGVzc29uOiBMZXNzb24pIHsgICAgXHJcbiAgICAgICAgbGV0IGJyZWFrVGltZSA9IEJyZWFrO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHJlZ2V4cCA9IG5ldyBSZWdFeHAoJ0InKTtcclxuICAgICAgICBjb25zdCBuYW1lID0gdGhpcy5nZXRQZXJpb2ROYW1lRm9yTGVzc29uKGxlc3Nvbik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKChuZXcgRGF0ZShsZXNzb24uc3RhcnREYXRlKS5nZXRIb3VycygpIDwgMTIpICYmIHJlZ2V4cC50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0RldGFpbHMgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5icmVha1BlcmlvZExhYmVsID0gYnJlYWtUaW1lLmFtQnJlYWs7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoKG5ldyBEYXRlKGxlc3Nvbi5zdGFydERhdGUpLmdldEhvdXJzKCkgPj0gMTIpICYmIHJlZ2V4cC50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0RldGFpbHMgPSBmYWxzZTtcclxuICAgICAgICAgICAgdGhpcy5icmVha1BlcmlvZExhYmVsID0gYnJlYWtUaW1lLnBtQnJlYWs7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvd0RldGFpbHMgPXRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Q3VycmVudExlc3NvbihsZXNzb246IExlc3Nvbik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGxldCB0b2RheSA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgICAgIGlmICgodG9kYXkgPj0gbmV3IERhdGUobGVzc29uLnN0YXJ0RGF0ZSkpICYmICh0b2RheSA8PSBuZXcgRGF0ZShsZXNzb24uZW5kRGF0ZSkpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldEhvbWV3b3JrRHVlRGF0ZShsZXNzb246IExlc3Nvbik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IGR1ZUhvbWV3b3JrID0gdGhpcy5hbGxIb21ld29ya3MuZmluZChoID0+XHJcbiAgICAgICAgICAgIGguc3ViamVjdCA9PSBsZXNzb24uc3ViamVjdFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGlmIChkdWVIb21ld29yayAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5hbGxEdWVIb21ld29ya3MucHVzaChkdWVIb21ld29yayk7XHJcbiAgICAgICAgICAgIGxldCBpc0R1ZSA9IHRoaXMuaG9tZXdvcmtTZXJ2aWNlLmlzTmVhckR1ZURhdGUoZHVlSG9tZXdvcmspXHJcblxyXG4gICAgICAgICAgICBpZiAoaXNEdWUgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNEdWVMZXNzb24gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ob21ld29ya0ljb24gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ZTkxZik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlc3NvbnMoKSB7XHJcbiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMudGltZXRhYmxlU2VydmljZS5nZXRMZXNzb25zKClcclxuICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGxlc3NvbnMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxlc3NvbnMgPSBsZXNzb25zLnNvcnQgKChvYmoxOiBMZXNzb24sIG9iajI6IExlc3NvbikgID0+XHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUob2JqMS5zdGFydERhdGUpLmdldEhvdXJzKCkgLSBuZXcgRGF0ZShvYmoyLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbGxMZXNzb25zID0gbGVzc29ucztcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldExlc3NvbnNGb3JEYXRlKHRoaXMubGVzc29uRGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlc3NvbnNGb3JEYXRlKGRhdGU6IERhdGUpIHtcclxuICAgICAgICBpZiAoIXRoaXMuYWxsTGVzc29ucykge1xyXG4gICAgICAgICAgICB0aGlzLmxlc3NvbnNGb3JEYXRlID0gW107XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubGVzc29uc0ZvckRhdGUgPSB0aGlzLmFsbExlc3NvbnMuZmlsdGVyKGwgPT4gbmV3IERhdGUobC5zdGFydERhdGUpLnRvRGF0ZVN0cmluZygpID09PSBkYXRlLnRvRGF0ZVN0cmluZygpKTtcclxuICAgICAgICB0aGlzLmdldFRvdGFsTGVzc29uKCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVyaW9kcygpIHtcclxuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2goXHJcbiAgICAgICAgICAgIHRoaXMudGltZXRhYmxlU2VydmljZS5nZXRQZXJpb2RzKG5ldyBEYXRlKHRoaXMuc3RhcnREYXRlKSwgbmV3IERhdGUodGhpcy5lbmREYXRlKSlcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUocCA9PiB7IFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsUGVyaW9kcyA9IHA7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQZXJpb2ROYW1lRm9yTGVzc29uKGxlc3NvbjogTGVzc29uKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgbmFtZSA9IFwiXCI7XHJcblxyXG4gICAgICAgIGNvbnN0IHN0YXJ0TGVzc29uRGF5ID0gbmV3IERhdGUobGVzc29uLnN0YXJ0RGF0ZSkuZ2V0RGF5KCk7XHJcbiAgICAgICAgY29uc3Qgc3RhcnRMZXNzb25Ib3VyID0gbmV3IERhdGUobGVzc29uLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKTtcclxuICAgICAgICBjb25zdCBzdGFydExlc3Nvbk1pbnV0ZSA9IG5ldyBEYXRlKGxlc3Nvbi5zdGFydERhdGUpLmdldE1pbnV0ZXMoKTtcclxuICAgICAgICBjb25zdCBlbmRMZXNzb25EYXkgPSBuZXcgRGF0ZShsZXNzb24uZW5kRGF0ZSkuZ2V0RGF5KCk7XHJcbiAgICAgICAgY29uc3QgZW5kTGVzc29uSG91ciA9IG5ldyBEYXRlKGxlc3Nvbi5lbmREYXRlKS5nZXRIb3VycygpO1xyXG4gICAgICAgIGNvbnN0IGVuZExlc3Nvbk1pbnV0ZSA9IG5ldyBEYXRlKGxlc3Nvbi5lbmREYXRlKS5nZXRNaW51dGVzKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHBlcmlvZCA9IHRoaXMuYWxsUGVyaW9kcy5maW5kKHAgPT4gXHJcbiAgICAgICAgICAgIG5ldyBEYXRlKHAuc3RhcnREYXRlKS5nZXREYXkoKSA9PSBzdGFydExlc3NvbkRheSAmJiBcclxuICAgICAgICAgICAgbmV3IERhdGUocC5zdGFydERhdGUpLmdldEhvdXJzKCkgPT0gc3RhcnRMZXNzb25Ib3VyICYmIFxyXG4gICAgICAgICAgICBuZXcgRGF0ZShwLnN0YXJ0RGF0ZSkuZ2V0TWludXRlcygpID09IHN0YXJ0TGVzc29uTWludXRlICYmIFxyXG4gICAgICAgICAgICBuZXcgRGF0ZShwLmVuZERhdGUpLmdldERheSgpID09IGVuZExlc3NvbkRheSAmJiBcclxuICAgICAgICAgICAgbmV3IERhdGUocC5lbmREYXRlKS5nZXRIb3VycygpID09IGVuZExlc3NvbkhvdXIgJiYgXHJcbiAgICAgICAgICAgIG5ldyBEYXRlKHAuZW5kRGF0ZSkuZ2V0TWludXRlcygpID09IGVuZExlc3Nvbk1pbnV0ZVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGlmIChwZXJpb2Qpe1xyXG4gICAgICAgICAgICBuYW1lID0gcGVyaW9kLm5hbWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBuYW1lO1xyXG4gICAgfSAgXHJcblxyXG4gICAgZ2V0U3ViamVjdENvbG91cihsZXNzb246IExlc3Nvbik6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IHN1YmplY3QgPSBTdWJqZWN0O1xyXG4gICAgICAgIGxldCBjb2xvciA9IFwiXCI7XHJcblxyXG4gICAgICAgIHN3aXRjaCAobGVzc29uLnN1YmplY3QpIHtcclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0LmFydDoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbG9yID0gXCIjOEIwMDAwXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0LmNvbXB1dGluZzoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbG9yID0gXCIjOEI0NTEzXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0LmRlc2lnbjoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbG9yID0gXCIjODA4MDAwXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0LmVuZ2xpc2g6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb2xvciA9IFwiIzJFQ0NGQVwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5nZW9ncmFwaHk6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb2xvciA9IFwiI0ZBNThGNFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5oaXN0b3J5OiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sb3IgPSBcIiMwNEI0MDRcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QubGFuZ3VhZ2VzOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sb3IgPSBcIiNCRjAwRkZcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QubWF0aDoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNvbG9yID0gXCIjRkY4MDAwXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0Lm11c2ljOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sb3IgPSBcIiM2NDJFRkVcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QucGU6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb2xvciA9IFwiI0ZGRkYwMFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5yZWc6IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjb2xvciA9IFwiIzA4NkE4N1wiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5zY2llbmNlOiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY29sb3IgPSBcIiNGRjAwMDBcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRUb3RhbExlc3NvbigpIHtcclxuICAgICAgICBpZiAodGhpcy5sZXNzb25zRm9yRGF0ZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5oYXNMZXNzb24gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzTGVzc29uID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25MZWZ0U3dpcGVDbGljaygpIHtcclxuICAgICAgICBsZXQgb25lV2Vla1ByZXYgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIG9uZVdlZWtQcmV2LnNldERhdGUob25lV2Vla1ByZXYuZ2V0RGF0ZSgpIC0gKG9uZVdlZWtQcmV2LmdldERheSgpICsgNikpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMubG9nZ2luZ1NlcnZpY2UubG9nKFwic3dpcGUgbGVmdFwiKTtcclxuICAgICAgICB0aGlzLmxlc3NvbkRhdGUgPSBuZXcgRGF0ZSh0aGlzLmxlc3NvbkRhdGUuc2V0RGF0ZSh0aGlzLmxlc3NvbkRhdGUuZ2V0RGF0ZSgpIC0gMSkpO1xyXG4gICAgICAgIGlmIChvbmVXZWVrUHJldiA8IHRoaXMubGVzc29uRGF0ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmdldExlc3NvbnNGb3JEYXRlKHRoaXMubGVzc29uRGF0ZSk7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdExlc3NvbiA9IGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9nZ2luZ1NlcnZpY2UubG9nKFwiTGFzdCBsZXNzb24gZm9yIHRoZSBwcmV2aW91cyB3ZWVrXCIpO1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RMZXNzb24gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvblJpZ2h0U3dpcGVDbGljaygpIHtcclxuICAgICAgICBsZXQgdHdvV2Vla3NGdXR1cmUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIHR3b1dlZWtzRnV0dXJlLnNldERhdGUodHdvV2Vla3NGdXR1cmUuZ2V0RGF0ZSgpIC0gKHR3b1dlZWtzRnV0dXJlLmdldERheSgpIC0gMjApKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2dnaW5nU2VydmljZS5sb2coXCJzd2lwZSByaWdodFwiKTtcclxuICAgICAgICB0aGlzLmxlc3NvbkRhdGUgPSBuZXcgRGF0ZSh0aGlzLmxlc3NvbkRhdGUuc2V0RGF0ZSh0aGlzLmxlc3NvbkRhdGUuZ2V0RGF0ZSgpICsgMSkpO1xyXG4gICAgICAgIGlmICh0d29XZWVrc0Z1dHVyZSA+PSB0aGlzLmxlc3NvbkRhdGUpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRMZXNzb25zRm9yRGF0ZSh0aGlzLmxlc3NvbkRhdGUpO1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RMZXNzb24gPSBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmxvZ2dpbmdTZXJ2aWNlLmxvZyhcIkxhc3QgbGVzc29uIGZvciB0aGUgbmV4dCB0d28gd2Vla3NcIik7XHJcbiAgICAgICAgICAgIHRoaXMubGFzdExlc3NvbiA9IHRydWU7XHJcbiAgICAgICAgfSAgIFxyXG4gICAgfSAgIFxyXG4gICAgICAgIFxyXG4gICAgb25Td2lwZShhcmdzOiBTd2lwZUdlc3R1cmVFdmVudERhdGEpIHtcclxuICAgICAgICBpZiAodGhpcy5sYXN0TGVzc29uID09PSBmYWxzZSkge1xyXG4gICAgICAgICAgICB0aGlzLmxvZ2dpbmdTZXJ2aWNlLmxvZyhcInRpbWV0YWJsZSBzd2lwZSBkaXJlY3Rpb25cIiArIGFyZ3MuZGlyZWN0aW9uLnRvU3RyaW5nKCkpO1xyXG4gICAgICAgICAgICBpZiAoYXJncy5kaXJlY3Rpb24gPT09IDEpe1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkxlZnRTd2lwZUNsaWNrKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uUmlnaHRTd2lwZUNsaWNrKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmxvZ2dpbmdTZXJ2aWNlLmxvZyhcIkxvY2sgVGltZXRhYmxlIHN3aXBlXCIpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBvblRhcEhvbWV3b3JrKGxlc3NvbjogTGVzc29uKSB7XHJcbiAgICAgICAgY29uc3QgaG9tZXdvcmsgPSB0aGlzLmFsbER1ZUhvbWV3b3Jrcy5maW5kKGggPT5cclxuICAgICAgICAgICAgaC5zdWJqZWN0ID09IGxlc3Nvbi5zdWJqZWN0XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW2AvaG9tZXdvcmtkZXRhaWxzLyR7aG9tZXdvcmsuaWR9YF0pO1xyXG4gICAgfVxyXG59Il19