"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var common_1 = require("@angular/common");
var timetable_model_1 = require("../model/timetable.model");
var login_service_1 = require("../service/login.service");
var timetable_service_1 = require("../service/timetable.service");
var user_model_1 = require("~/model/user.model");
var stack_layout_1 = require("tns-core-modules/ui/layouts/stack-layout/stack-layout");
var TimetableComponent = /** @class */ (function () {
    function TimetableComponent(location, loginService, timetableService) {
        this.location = location;
        this.loginService = loginService;
        this.timetableService = timetableService;
        this.isLoading = true;
        this.lesson = [];
        this.hasLesson = true;
    }
    TimetableComponent.prototype.ngOnInit = function () {
        this.lessonDate = new Date();
        this.period = new timetable_model_1.Periods;
        this.user = this.getLoggedInUser();
        this.getUserType();
        /* this.getParent(); */ // for testing
    };
    TimetableComponent.prototype.ngOnDestroy = function () {
        if (this.subscription != undefined) {
            this.subscription.unsubscribe();
        }
    };
    TimetableComponent.prototype.getChild = function (parent) {
        if (parent.childId.length > 1) {
            for (var i = 0; i < parent.childId.length; i++) {
                console.log("student id: " + parent.childId[i]);
            }
        }
        else {
            this.userId = parent.childId[0];
            this.getLesson(this.userId);
        }
    };
    TimetableComponent.prototype.getLesson = function (userId) {
        var _this = this;
        this.subscription = this.timetableService.getLesson(userId)
            .subscribe(function (lesson) {
            lesson = lesson.filter(function (all) { return new Date(all.startDate).toDateString() === _this.lessonDate.toDateString(); });
            lesson = lesson.sort(function (obj1, obj2) {
                return new Date(obj1.startDate).getHours() - new Date(obj2.startDate).getHours();
            });
            _this.getTotalLesson(lesson);
            /* this.getSubjectColour(lesson); */
            _this.lesson = lesson;
            _this.isLoading = false;
        });
    };
    TimetableComponent.prototype.getLoggedInUser = function () {
        var user = this.loginService.getLoggedInUser();
        return user;
    };
    TimetableComponent.prototype.getParent = function () {
        var _this = this;
        this.subscription = this.timetableService.getParent(3) //this.user.id
            .subscribe(function (parent) {
            _this.parent = parent;
            _this.getChild(parent);
        });
    };
    /* for testing */
    TimetableComponent.prototype.getPeriod = function (startDate, endDate) {
        var _this = this;
        var pName = "";
        this.subscription = this.timetableService.getPeriod(new Date(startDate), new Date(endDate))
            .subscribe(function (period) {
            _this.period = period;
            if (_this.period.name === undefined) {
                pName = _this.period.name;
            }
            else {
                pName = "ERROR";
            }
        });
        return pName;
    };
    TimetableComponent.prototype.getTotalLesson = function (lesson) {
        if (lesson.length === 0) {
            this.hasLesson = false;
        }
        else {
            this.hasLesson = true;
        }
    };
    TimetableComponent.prototype.getUserType = function () {
        if (this.user.usertype === user_model_1.UserType.parent) {
            this.getParent();
        }
        else {
            this.userId = this.user.id;
            this.getLesson(this.userId);
        }
    };
    TimetableComponent.prototype.goBack = function () {
        this.location.back();
    };
    TimetableComponent.prototype.onLeftSwipeClick = function () {
        this.isLoading = true;
        this.lessonDate = new Date(this.lessonDate.setDate(this.lessonDate.getDate() - 1));
        this.getLesson(this.userId);
    };
    TimetableComponent.prototype.onRightSwipeClick = function () {
        this.isLoading = true;
        this.lessonDate = new Date(this.lessonDate.setDate(this.lessonDate.getDate() + 1));
        this.getLesson(this.userId);
    };
    /* for testing */
    TimetableComponent.prototype.getSubjectColour = function (lesson) {
        for (var i = 0; i < lesson.length; i++) {
            switch (lesson[i].subject) {
                case "Science":
                    this.subjectColour.backgroundColor = "green";
                default:
                    this.subjectColour.backgroundColor = "gray";
            }
        }
    };
    __decorate([
        core_1.ViewChild("subjectColour"),
        __metadata("design:type", stack_layout_1.StackLayout)
    ], TimetableComponent.prototype, "subjectColour", void 0);
    TimetableComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'ns-timetable',
            templateUrl: './timetable.component.html',
            styleUrls: ['./timetable.component.less']
        }),
        __metadata("design:paramtypes", [common_1.Location,
            login_service_1.LoginService,
            timetable_service_1.TimetableService])
    ], TimetableComponent);
    return TimetableComponent;
}());
exports.TimetableComponent = TimetableComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXRhYmxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRpbWV0YWJsZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBbUY7QUFDbkYsMENBQTJDO0FBRzNDLDREQUE0RDtBQUM1RCwwREFBd0Q7QUFFeEQsa0VBQWdFO0FBQ2hFLGlEQUF5RDtBQUV6RCxzRkFBb0Y7QUFRcEY7SUFlSSw0QkFDWSxRQUFrQixFQUNsQixZQUEwQixFQUMxQixnQkFBa0M7UUFGbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBZjlDLGNBQVMsR0FBRyxJQUFJLENBQUM7UUFDakIsV0FBTSxHQUFjLEVBQUUsQ0FBQztRQU92QixjQUFTLEdBQUcsSUFBSSxDQUFDO0lBUWIsQ0FBQztJQUVMLHFDQUFRLEdBQVI7UUFDSSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHlCQUFPLENBQUM7UUFFMUIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLHVCQUF1QixDQUFDLGNBQWM7SUFDMUMsQ0FBQztJQUVELHdDQUFXLEdBQVg7UUFDSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDakMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNwQyxDQUFDO0lBQ0wsQ0FBQztJQUVELHFDQUFRLEdBQVIsVUFBUyxNQUFjO1FBQ25CLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsR0FBRyxD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Vmlld0NoaWxkLCBFbGVtZW50UmVmLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJ1xyXG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgTGVzc29ucywgUGVyaW9kcyB9IGZyb20gXCIuLi9tb2RlbC90aW1ldGFibGUubW9kZWxcIjtcclxuaW1wb3J0IHsgTG9naW5TZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2UvbG9naW4uc2VydmljZVwiO1xyXG5pbXBvcnQgeyBQYXJlbnQgfSBmcm9tICcuLi9tb2RlbC91c2VyLm1vZGVsJztcclxuaW1wb3J0IHsgVGltZXRhYmxlU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlL3RpbWV0YWJsZS5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFVzZXJNb2RlbCwgVXNlclR5cGUgfSBmcm9tICd+L21vZGVsL3VzZXIubW9kZWwnO1xyXG5cclxuaW1wb3J0IHsgU3RhY2tMYXlvdXQgfSBmcm9tICd0bnMtY29yZS1tb2R1bGVzL3VpL2xheW91dHMvc3RhY2stbGF5b3V0L3N0YWNrLWxheW91dCc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXHJcbiAgICBzZWxlY3RvcjogJ25zLXRpbWV0YWJsZScsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vdGltZXRhYmxlLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHN0eWxlVXJsczogWycuL3RpbWV0YWJsZS5jb21wb25lbnQubGVzcyddXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUaW1ldGFibGVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgICBwcml2YXRlIHN1YnNjcmlwdGlvbiA6IFN1YnNjcmlwdGlvbjtcclxuICAgIFxyXG4gICAgaXNMb2FkaW5nID0gdHJ1ZTtcclxuICAgIGxlc3NvbjogTGVzc29uc1tdID0gW107XHJcbiAgICBsZXNzb25EYXRlOiBEYXRlO1xyXG4gICAgcGFyZW50OiBQYXJlbnQ7XHJcbiAgICBwZXJpb2Q6IFBlcmlvZHM7XHJcbiAgICB1c2VyOiBVc2VyTW9kZWw7XHJcbiAgICB1c2VySWQ6IG51bWJlcjtcclxuICAgIFxyXG4gICAgaGFzTGVzc29uID0gdHJ1ZTtcclxuXHJcbiAgICBAVmlld0NoaWxkKFwic3ViamVjdENvbG91clwiKSBzdWJqZWN0Q29sb3VyOiBTdGFja0xheW91dDtcclxuICAgICAgIFxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24sXHJcbiAgICAgICAgcHJpdmF0ZSBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHRpbWV0YWJsZVNlcnZpY2U6IFRpbWV0YWJsZVNlcnZpY2UsXHJcbiAgICApIHsgfVxyXG5cclxuICAgIG5nT25Jbml0KCkgeyBcclxuICAgICAgICB0aGlzLmxlc3NvbkRhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIHRoaXMucGVyaW9kID0gbmV3IFBlcmlvZHM7XHJcblxyXG4gICAgICAgIHRoaXMudXNlciA9IHRoaXMuZ2V0TG9nZ2VkSW5Vc2VyKCk7XHJcbiAgICAgICAgdGhpcy5nZXRVc2VyVHlwZSgpO1xyXG4gICAgICAgIC8qIHRoaXMuZ2V0UGFyZW50KCk7ICovIC8vIGZvciB0ZXN0aW5nXHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRDaGlsZChwYXJlbnQ6IFBhcmVudCkge1xyXG4gICAgICAgIGlmIChwYXJlbnQuY2hpbGRJZC5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaTxwYXJlbnQuY2hpbGRJZC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJzdHVkZW50IGlkOiBcIiArIHBhcmVudC5jaGlsZElkW2ldKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudXNlcklkID0gcGFyZW50LmNoaWxkSWRbMF07XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TGVzc29uKHRoaXMudXNlcklkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TGVzc29uKHVzZXJJZDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLnRpbWV0YWJsZVNlcnZpY2UuZ2V0TGVzc29uKHVzZXJJZClcclxuICAgICAgICAgICAgLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIGxlc3NvbiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGVzc29uID0gbGVzc29uLmZpbHRlcihhbGwgPT4gbmV3IERhdGUoYWxsLnN0YXJ0RGF0ZSkudG9EYXRlU3RyaW5nKCkgPT09IHRoaXMubGVzc29uRGF0ZS50b0RhdGVTdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbGVzc29uID0gbGVzc29uLnNvcnQgKChvYmoxOiBMZXNzb25zLCBvYmoyOiBMZXNzb25zKSAgPT5cclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShvYmoxLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKSAtIG5ldyBEYXRlKG9iajIuc3RhcnREYXRlKS5nZXRIb3VycygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0VG90YWxMZXNzb24obGVzc29uKTtcclxuICAgICAgICAgICAgICAgICAgICAvKiB0aGlzLmdldFN1YmplY3RDb2xvdXIobGVzc29uKTsgKi9cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxlc3NvbiA9IGxlc3NvbjtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRMb2dnZWRJblVzZXIoKSB7XHJcbiAgICAgICAgY29uc3QgdXNlciA9IHRoaXMubG9naW5TZXJ2aWNlLmdldExvZ2dlZEluVXNlcigpOyBcclxuICAgICAgICByZXR1cm4gdXNlcjtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQYXJlbnQoKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLnRpbWV0YWJsZVNlcnZpY2UuZ2V0UGFyZW50KDMpIC8vdGhpcy51c2VyLmlkXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBwYXJlbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFyZW50ID0gcGFyZW50O1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0Q2hpbGQocGFyZW50KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKVxyXG4gICAgfVxyXG5cclxuICAgIC8qIGZvciB0ZXN0aW5nICovXHJcbiAgICBnZXRQZXJpb2Qoc3RhcnREYXRlOiBEYXRlLCBlbmREYXRlOiBEYXRlKSB7XHJcbiAgICAgICAgbGV0IHBOYW1lID0gXCJcIjtcclxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMudGltZXRhYmxlU2VydmljZS5nZXRQZXJpb2QobmV3IERhdGUoc3RhcnREYXRlKSwgbmV3IERhdGUoZW5kRGF0ZSkpXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICBwZXJpb2QgPT4geyBcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBlcmlvZCA9IHBlcmlvZDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wZXJpb2QubmFtZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBOYW1lID0gdGhpcy5wZXJpb2QubmFtZTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwTmFtZSA9IFwiRVJST1JcIjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIHJldHVybiBwTmFtZTtcclxuICAgIH0gIFxyXG5cclxuICAgIGdldFRvdGFsTGVzc29uKGxlc3NvbjogTGVzc29uc1tdKSB7XHJcbiAgICAgICAgaWYgKGxlc3Nvbi5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5oYXNMZXNzb24gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzTGVzc29uID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VXNlclR5cGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMudXNlci51c2VydHlwZSA9PT0gVXNlclR5cGUucGFyZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0UGFyZW50KCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy51c2VySWQgPSB0aGlzLnVzZXIuaWQ7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TGVzc29uKHRoaXMudXNlcklkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ29CYWNrKCk6IHZvaWQge1xyXG5cdFx0dGhpcy5sb2NhdGlvbi5iYWNrKCk7XHJcbiAgICB9ICBcclxuICAgIFxyXG4gICAgb25MZWZ0U3dpcGVDbGljaygpIHtcclxuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5sZXNzb25EYXRlID0gbmV3IERhdGUodGhpcy5sZXNzb25EYXRlLnNldERhdGUodGhpcy5sZXNzb25EYXRlLmdldERhdGUoKSAtIDEpKTtcclxuICAgICAgICB0aGlzLmdldExlc3Nvbih0aGlzLnVzZXJJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25SaWdodFN3aXBlQ2xpY2soKSB7XHJcbiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMubGVzc29uRGF0ZSA9IG5ldyBEYXRlKHRoaXMubGVzc29uRGF0ZS5zZXREYXRlKHRoaXMubGVzc29uRGF0ZS5nZXREYXRlKCkgKyAxKSk7XHJcbiAgICAgICAgdGhpcy5nZXRMZXNzb24odGhpcy51c2VySWQpO1xyXG4gICAgfSAgIFxyXG5cclxuICAgIFxyXG5cclxuICAgIC8qIGZvciB0ZXN0aW5nICovXHJcbiAgICBnZXRTdWJqZWN0Q29sb3VyKGxlc3NvbjogTGVzc29uc1tdKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaT0wOyBpPGxlc3Nvbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBzd2l0Y2ggKGxlc3NvbltpXS5zdWJqZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiU2NpZW5jZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3ViamVjdENvbG91ci5iYWNrZ3JvdW5kQ29sb3I9XCJncmVlblwiO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN1YmplY3RDb2xvdXIuYmFja2dyb3VuZENvbG9yID0gXCJncmF5XCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19