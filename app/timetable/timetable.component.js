"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var timetable_model_1 = require("../model/timetable.model");
var timetable_model_2 = require("~/model/timetable.model");
var appvalues_service_1 = require("~/service/appvalues.service");
var homework_service_1 = require("~/service/homework.service");
var logging_service_1 = require("~/service/logging.service");
var timetable_service_1 = require("../service/timetable.service");
var TimetableComponent = /** @class */ (function () {
    function TimetableComponent(appValuesService, homeworkService, loggingService, router, timetableService) {
        this.appValuesService = appValuesService;
        this.homeworkService = homeworkService;
        this.loggingService = loggingService;
        this.router = router;
        this.timetableService = timetableService;
        this.subscriptions = [];
        this.breakPeriodLabel = "";
        this.homeworkIcon = "";
        this.lessonDate = new Date();
        this.startDate = new Date();
        this.endDate = new Date();
        this.allHomeworks = [];
        this.allDueHomeworks = [];
        this.allLessons = [];
        this.lessonsForDate = [];
        this.allPeriods = [];
        this.periodsForDate = [];
        this.tabDates = [];
        this.current = false;
        this.hasLesson = true;
        this.isDueLesson = false;
        this.isLoading = true;
        this.lastLesson = false;
        this.showDetails = false;
        this.dateRange = [];
    }
    TimetableComponent.prototype.ngOnInit = function () {
        this.loggedInUser = this.appValuesService.getLoggedInUser();
        this.startDate.setDate(this.startDate.getDate() - (this.startDate.getDay() + 7));
        this.endDate.setDate(this.endDate.getDate() - (this.endDate.getDay() - 14));
        this.getAllHomework();
        this.getLessonsDateRange();
        this.getLessons();
        this.getPeriods();
    };
    TimetableComponent.prototype.ngOnDestroy = function () {
        if (this.subscriptions) {
            for (var _i = 0, _a = this.subscriptions; _i < _a.length; _i++) {
                var subscription = _a[_i];
                subscription.unsubscribe();
            }
        }
    };
    TimetableComponent.prototype.getAllHomework = function () {
        var _this = this;
        this.subscriptions.push(this.homeworkService.getStudentHomework(this.loggedInUser.id)
            .subscribe(function (homework) {
            _this.allHomeworks = homework;
        }));
    };
    TimetableComponent.prototype.getBreakPeriod = function (lesson) {
        var breakTimeName = timetable_model_2.Break;
        this.breakPeriodLabel = "";
        var regexp = new RegExp('B');
        var name = this.getPeriodNameForLesson(lesson);
        if ((new Date(lesson.startDate).getHours() < 12) && regexp.test(name)) {
            this.breakPeriodLabel = breakTimeName.amBreak;
            this.showDetails = false;
            return true;
        }
        if ((new Date(lesson.startDate).getHours() >= 12) && regexp.test(name)) {
            this.breakPeriodLabel = breakTimeName.pmBreak;
            this.showDetails = false;
            return true;
        }
        this.showDetails = true;
        return false;
    };
    TimetableComponent.prototype.getCurrentLesson = function (lesson) {
        var today = new Date();
        if ((today >= new Date(lesson.startDate)) && (today <= new Date(lesson.endDate))) {
            this.current = true;
            return true;
        }
        else {
            this.current = false;
            return false;
        }
    };
    TimetableComponent.prototype.getHomeworkDueDate = function (lesson) {
        var dueHomework = this.allHomeworks.find(function (h) {
            return h.subject == lesson.subject;
        });
        if (dueHomework != undefined) {
            this.allDueHomeworks.push(dueHomework);
            var isDue = this.homeworkService.isDue(dueHomework);
            if (isDue === true) {
                this.isDueLesson = true;
                this.homeworkIcon = String.fromCharCode(0xe91f);
                return true;
            }
        }
        return false;
    };
    TimetableComponent.prototype.getLessons = function () {
        var _this = this;
        this.subscriptions.push(this.timetableService.getLessons()
            .subscribe(function (lessons) {
            lessons = lessons.sort(function (obj1, obj2) {
                return new Date(obj1.startDate).getHours() - new Date(obj2.startDate).getHours();
            });
            _this.allLessons = lessons;
            //this.getLessonsForDate(this.lessonDate);
            _this.getTabDateLesson();
            _this.tabSelectedIndex++;
        }));
    };
    TimetableComponent.prototype.getLessonsDateRange = function () {
        // one week previous date
        var minDate = new Date();
        minDate.setDate(minDate.getDate() - (minDate.getDay() + 7));
        // two weeks future date
        var maxDate = new Date();
        maxDate.setDate(maxDate.getDate() - (maxDate.getDay() - 13));
        var tabItemDate = new Date();
        do {
            tabItemDate = new Date(minDate.setDate(minDate.getDate() + 1));
            this.dateRange.push(tabItemDate);
            if (tabItemDate.getDate() === this.lessonDate.getDate()) {
                this.tabSelectedIndex = this.dateRange.findIndex(function (x) { return x == tabItemDate; });
            }
        } while (tabItemDate < maxDate);
    };
    TimetableComponent.prototype.getLessonsForDate = function (date) {
        if (!this.allLessons) {
            this.lessonsForDate = [];
            return;
        }
        this.lessonsForDate = this.allLessons.filter(function (l) { return new Date(l.startDate).toDateString() === date.toDateString(); });
        this.getTotalLesson();
    };
    TimetableComponent.prototype.getPeriods = function () {
        var _this = this;
        this.subscriptions.push(this.timetableService.getPeriods(new Date(this.startDate), new Date(this.endDate))
            .subscribe(function (p) {
            _this.allPeriods = p;
        }));
    };
    TimetableComponent.prototype.getPeriodNameForLesson = function (lesson) {
        var name = "";
        var startLessonDay = new Date(lesson.startDate).getDay();
        var startLessonHour = new Date(lesson.startDate).getHours();
        var startLessonMinute = new Date(lesson.startDate).getMinutes();
        var endLessonDay = new Date(lesson.endDate).getDay();
        var endLessonHour = new Date(lesson.endDate).getHours();
        var endLessonMinute = new Date(lesson.endDate).getMinutes();
        var period = this.allPeriods.find(function (p) {
            return new Date(p.startDate).getDay() == startLessonDay &&
                new Date(p.startDate).getHours() == startLessonHour &&
                new Date(p.startDate).getMinutes() == startLessonMinute &&
                new Date(p.endDate).getDay() == endLessonDay &&
                new Date(p.endDate).getHours() == endLessonHour &&
                new Date(p.endDate).getMinutes() == endLessonMinute;
        });
        if (period) {
            name = period.name;
        }
        return name;
    };
    TimetableComponent.prototype.getSubjectColour = function (lesson) {
        var subject = timetable_model_2.Subject;
        var color = "";
        switch (lesson.subject) {
            case subject.art: {
                color = "#8B0000";
                break;
            }
            case subject.computing: {
                color = "#8B4513";
                break;
            }
            case subject.design: {
                color = "#808000";
                break;
            }
            case subject.english: {
                color = "#2ECCFA";
                break;
            }
            case subject.geography: {
                color = "#FA58F4";
                break;
            }
            case subject.history: {
                color = "#04B404";
                break;
            }
            case subject.languages: {
                color = "#BF00FF";
                break;
            }
            case subject.math: {
                color = "#FF8000";
                break;
            }
            case subject.music: {
                color = "#642EFE";
                break;
            }
            case subject.pe: {
                color = "#FFFF00";
                break;
            }
            case subject.reg: {
                color = "#086A87";
                break;
            }
            case subject.science: {
                color = "#FF0000";
                break;
            }
        }
        return color;
    };
    TimetableComponent.prototype.getTabDateLesson = function () {
        for (var _i = 0, _a = this.dateRange; _i < _a.length; _i++) {
            var tabDate = _a[_i];
            this.getLessonsForDate(tabDate);
            var timetableTab = new timetable_model_1.TimetableTab;
            timetableTab.date = tabDate;
            timetableTab.lessons = this.lessonsForDate;
            this.tabDates.push(timetableTab);
            console.log(this.tabDates);
        }
        this.isLoading = false;
    };
    TimetableComponent.prototype.printTabDates = function () {
        var ctr = 0;
        for (var _i = 0, _a = this.tabDates; _i < _a.length; _i++) {
            var tab = _a[_i];
            console.log('Class: ' + tab.lessons[ctr].class + '  Teacher: ' + tab.lessons[ctr].teacher);
            ctr++;
        }
    };
    TimetableComponent.prototype.getTotalLesson = function () {
        if (this.lessonsForDate.length === 0) {
            this.hasLesson = false;
        }
        else {
            this.hasLesson = true;
        }
    };
    TimetableComponent.prototype.onTabSwipe = function (args) {
        if (args.oldIndex !== -1) {
            //this.getLessonsForDate(this.tabDate[args.newIndex]);
        }
    };
    TimetableComponent.prototype.onTapHomework = function (lesson) {
        var homework = this.allDueHomeworks.find(function (h) {
            return h.subject == lesson.subject;
        });
        this.router.navigate(["/homeworkdetails/" + homework.id]);
    };
    TimetableComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: 'ns-timetable',
            templateUrl: './timetable.component.html',
            styleUrls: ['./timetable.component.less']
        }),
        __metadata("design:paramtypes", [appvalues_service_1.AppValuesService,
            homework_service_1.HomeworkService,
            logging_service_1.LoggingService,
            router_1.Router,
            timetable_service_1.TimetableService])
    ], TimetableComponent);
    return TimetableComponent;
}());
exports.TimetableComponent = TimetableComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXRhYmxlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRpbWV0YWJsZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBMkU7QUFDM0UsMENBQXlDO0FBSXpDLDREQUF3RTtBQUN4RSwyREFBeUQ7QUFHekQsaUVBQStEO0FBQy9ELCtEQUE2RDtBQUM3RCw2REFBMkQ7QUFDM0Qsa0VBQWdFO0FBU2hFO0lBaUNJLDRCQUNZLGdCQUFrQyxFQUNsQyxlQUFnQyxFQUNoQyxjQUE4QixFQUM5QixNQUFjLEVBQ2QsZ0JBQWtDO1FBSmxDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2QscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQXJDdEMsa0JBQWEsR0FBb0IsRUFBRSxDQUFDO1FBRTVDLHFCQUFnQixHQUFHLEVBQUUsQ0FBQztRQUN0QixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUlsQixlQUFVLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM5QixjQUFTLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUM3QixZQUFPLEdBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUUzQixpQkFBWSxHQUFlLEVBQUUsQ0FBQztRQUM5QixvQkFBZSxHQUFlLEVBQUUsQ0FBQztRQUVqQyxlQUFVLEdBQWEsRUFBRSxDQUFDO1FBQzFCLG1CQUFjLEdBQWEsRUFBRSxDQUFDO1FBRTlCLGVBQVUsR0FBYSxFQUFFLENBQUM7UUFDMUIsbUJBQWMsR0FBYSxFQUFFLENBQUM7UUFFOUIsYUFBUSxHQUFtQixFQUFFLENBQUM7UUFFOUIsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUNoQixjQUFTLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLGNBQVMsR0FBRyxJQUFJLENBQUM7UUFDakIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixnQkFBVyxHQUFHLEtBQUssQ0FBQztRQUVwQixjQUFTLEdBQUcsRUFBRSxDQUFDO0lBU1gsQ0FBQztJQUVMLHFDQUFRLEdBQVI7UUFDSSxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUU1RCxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2pGLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFNUUsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVELHdDQUFXLEdBQVg7UUFDSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUNyQixHQUFHLENBQUMsQ0FBcUIsVUFBa0IsRUFBbEIsS0FBQSxJQUFJLENBQUMsYUFBYSxFQUFsQixjQUFrQixFQUFsQixJQUFrQjtnQkFBdEMsSUFBSSxZQUFZLFNBQUE7Z0JBRWpCLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUM5QjtRQUNMLENBQUM7SUFDTCxDQUFDO0lBRUQsMkNBQWMsR0FBZDtRQUFBLGlCQVFDO1FBUEcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQzthQUNoRixTQUFTLENBQ04sVUFBQSxRQUFRO1lBQ0osS0FBSSxDQUFDLFlBQVksR0FBRyxRQUFRLENBQUM7UUFDakMsQ0FBQyxDQUNKLENBQ0osQ0FBQTtJQUNMLENBQUM7SUFFRCwyQ0FBYyxHQUFkLFVBQWUsTUFBYztRQUN6QixJQUFJLGFBQWEsR0FBRyx1QkFBSyxDQUFDO1FBRTFCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFFM0IsSUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWpELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDO1lBQzlDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JFLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxhQUFhLENBQUMsT0FBTyxDQUFDO1lBQzlDLElBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUVELElBQUksQ0FBQyxXQUFXLEdBQUUsSUFBSSxDQUFDO1FBQ3ZCLE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDakIsQ0FBQztJQUVELDZDQUFnQixHQUFoQixVQUFpQixNQUFjO1FBQzNCLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFFdkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7WUFDckIsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNqQixDQUFDO0lBQ0wsQ0FBQztJQUVELCtDQUFrQixHQUFsQixVQUFtQixNQUFjO1FBQzdCLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQztZQUN4QyxPQUFBLENBQUMsQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLE9BQU87UUFBM0IsQ0FBMkIsQ0FDOUIsQ0FBQztRQUVGLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ3ZDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFBO1lBRW5ELEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztnQkFDeEIsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNoRCxNQUFNLENBQUMsSUFBSSxDQUFDO1lBQ2hCLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsdUNBQVUsR0FBVjtRQUFBLGlCQWdCQztRQWZHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUU7YUFDckQsU0FBUyxDQUNOLFVBQUEsT0FBTztZQUNILE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFFLFVBQUMsSUFBWSxFQUFFLElBQVk7Z0JBRS9DLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3JGLENBQUMsQ0FBQyxDQUFDO1lBRUgsS0FBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7WUFDMUIsMENBQTBDO1lBQzFDLEtBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3hCLEtBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzVCLENBQUMsQ0FDSixDQUNKLENBQUM7SUFDTixDQUFDO0lBRUQsZ0RBQW1CLEdBQW5CO1FBQ0kseUJBQXlCO1FBQ3pCLElBQUksT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDekIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU1RCx3QkFBd0I7UUFDeEIsSUFBSSxPQUFPLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN6QixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTdELElBQUksV0FBVyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDN0IsR0FBRyxDQUFDO1lBQ0EsV0FBVyxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFakMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxLQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLElBQUksV0FBVyxFQUFoQixDQUFnQixDQUFDLENBQUM7WUFDNUUsQ0FBQztRQUNMLENBQUMsUUFBUSxXQUFXLEdBQUcsT0FBTyxFQUFFO0lBQ3BDLENBQUM7SUFFRCw4Q0FBaUIsR0FBakIsVUFBa0IsSUFBVTtRQUN4QixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ25CLElBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksRUFBRSxLQUFLLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBNUQsQ0FBNEQsQ0FBQyxDQUFDO1FBQ2hILElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsdUNBQVUsR0FBVjtRQUFBLGlCQU9DO1FBTkcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQ25CLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM3RSxTQUFTLENBQUMsVUFBQSxDQUFDO1lBQ1IsS0FBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxDQUFDLENBQ1QsQ0FBQztJQUNOLENBQUM7SUFFRCxtREFBc0IsR0FBdEIsVUFBdUIsTUFBYztRQUNqQyxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7UUFFZCxJQUFNLGNBQWMsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDM0QsSUFBTSxlQUFlLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzlELElBQU0saUJBQWlCLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xFLElBQU0sWUFBWSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN2RCxJQUFNLGFBQWEsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDMUQsSUFBTSxlQUFlLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRTlELElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQztZQUNqQyxPQUFBLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxjQUFjO2dCQUNoRCxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxFQUFFLElBQUksZUFBZTtnQkFDbkQsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxJQUFJLGlCQUFpQjtnQkFDdkQsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sRUFBRSxJQUFJLFlBQVk7Z0JBQzVDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxhQUFhO2dCQUMvQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLElBQUksZUFBZTtRQUxuRCxDQUttRCxDQUN0RCxDQUFDO1FBRUYsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUEsQ0FBQztZQUNSLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ3ZCLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRCw2Q0FBZ0IsR0FBaEIsVUFBaUIsTUFBYztRQUMzQixJQUFJLE9BQU8sR0FBRyx5QkFBTyxDQUFDO1FBQ3RCLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUVmLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLEtBQUssT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNmLEtBQUssR0FBRyxTQUFTLENBQUM7Z0JBQ2xCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxLQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDckIsS0FBSyxHQUFHLFNBQVMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1YsQ0FBQztZQUNELEtBQUssT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNsQixLQUFLLEdBQUcsU0FBUyxDQUFDO2dCQUNsQixLQUFLLENBQUM7WUFDVixDQUFDO1lBQ0QsS0FBSyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ25CLEtBQUssR0FBRyxTQUFTLENBQUM7Z0JBQ2xCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxLQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFDckIsS0FBSyxHQUFHLFNBQVMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1YsQ0FBQztZQUNELEtBQUssT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNuQixLQUFLLEdBQUcsU0FBUyxDQUFDO2dCQUNsQixLQUFLLENBQUM7WUFDVixDQUFDO1lBQ0QsS0FBSyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ3JCLEtBQUssR0FBRyxTQUFTLENBQUM7Z0JBQ2xCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxLQUFLLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDaEIsS0FBSyxHQUFHLFNBQVMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1YsQ0FBQztZQUNELEtBQUssT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNqQixLQUFLLEdBQUcsU0FBUyxDQUFDO2dCQUNsQixLQUFLLENBQUM7WUFDVixDQUFDO1lBQ0QsS0FBSyxPQUFPLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ2QsS0FBSyxHQUFHLFNBQVMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1YsQ0FBQztZQUNELEtBQUssT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNmLEtBQUssR0FBRyxTQUFTLENBQUM7Z0JBQ2xCLEtBQUssQ0FBQztZQUNWLENBQUM7WUFDRCxLQUFLLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDbkIsS0FBSyxHQUFHLFNBQVMsQ0FBQztnQkFDbEIsS0FBSyxDQUFDO1lBQ1YsQ0FBQztRQUNMLENBQUM7UUFFRCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2pCLENBQUM7SUFFRCw2Q0FBZ0IsR0FBaEI7UUFDSSxHQUFHLENBQUMsQ0FBZ0IsVUFBYyxFQUFkLEtBQUEsSUFBSSxDQUFDLFNBQVMsRUFBZCxjQUFjLEVBQWQsSUFBYztZQUE3QixJQUFJLE9BQU8sU0FBQTtZQUNaLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNoQyxJQUFJLFlBQVksR0FBRyxJQUFJLDhCQUFZLENBQUM7WUFFcEMsWUFBWSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7WUFDNUIsWUFBWSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQzNDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRWpDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzlCO1FBRUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7SUFDM0IsQ0FBQztJQUVELDBDQUFhLEdBQWI7UUFDSSxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDWixHQUFHLENBQUMsQ0FBWSxVQUFhLEVBQWIsS0FBQSxJQUFJLENBQUMsUUFBUSxFQUFiLGNBQWEsRUFBYixJQUFhO1lBQXhCLElBQUksR0FBRyxTQUFBO1lBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsYUFBYSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDM0YsR0FBRyxFQUFFLENBQUM7U0FDVDtJQUNMLENBQUM7SUFFRCwyQ0FBYyxHQUFkO1FBQ0ksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUMzQixDQUFDO1FBQ0QsSUFBSSxDQUFDLENBQUM7WUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUMxQixDQUFDO0lBQ0wsQ0FBQztJQUVELHVDQUFVLEdBQVYsVUFBVyxJQUFtQztRQUMxQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QixzREFBc0Q7UUFDMUQsQ0FBQztJQUNMLENBQUM7SUFFRCwwQ0FBYSxHQUFiLFVBQWMsTUFBYztRQUN4QixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFBLENBQUM7WUFDeEMsT0FBQSxDQUFDLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxPQUFPO1FBQTNCLENBQTJCLENBQzlCLENBQUM7UUFFRixJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDLHNCQUFvQixRQUFRLENBQUMsRUFBSSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBeFRRLGtCQUFrQjtRQU45QixnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFFBQVEsRUFBRSxjQUFjO1lBQ3hCLFdBQVcsRUFBRSw0QkFBNEI7WUFDekMsU0FBUyxFQUFFLENBQUMsNEJBQTRCLENBQUM7U0FDNUMsQ0FBQzt5Q0FtQ2dDLG9DQUFnQjtZQUNqQixrQ0FBZTtZQUNoQixnQ0FBYztZQUN0QixlQUFNO1lBQ0ksb0NBQWdCO09BdENyQyxrQkFBa0IsQ0F5VDlCO0lBQUQseUJBQUM7Q0FBQSxBQXpURCxJQXlUQztBQXpUWSxnREFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSdcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFNlbGVjdGVkSW5kZXhDaGFuZ2VkRXZlbnREYXRhIH0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvdGFiLXZpZXdcIjtcclxuXHJcbmltcG9ydCB7IExlc3NvbiwgUGVyaW9kLCBUaW1ldGFibGVUYWIgfSBmcm9tIFwiLi4vbW9kZWwvdGltZXRhYmxlLm1vZGVsXCI7XHJcbmltcG9ydCB7IFN1YmplY3QsIEJyZWFrIH0gZnJvbSAnfi9tb2RlbC90aW1ldGFibGUubW9kZWwnO1xyXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnfi9tb2RlbC91c2VyLm1vZGVsJztcclxuXHJcbmltcG9ydCB7IEFwcFZhbHVlc1NlcnZpY2UgfSBmcm9tICd+L3NlcnZpY2UvYXBwdmFsdWVzLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBIb21ld29ya1NlcnZpY2UgfSBmcm9tICd+L3NlcnZpY2UvaG9tZXdvcmsuc2VydmljZSc7XHJcbmltcG9ydCB7IExvZ2dpbmdTZXJ2aWNlIH0gZnJvbSAnfi9zZXJ2aWNlL2xvZ2dpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IFRpbWV0YWJsZVNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZS90aW1ldGFibGUuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBIb21ld29yayB9IGZyb20gJ34vbW9kZWwvaG9tZXdvcmsubW9kZWwnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxyXG4gICAgc2VsZWN0b3I6ICducy10aW1ldGFibGUnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL3RpbWV0YWJsZS5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi90aW1ldGFibGUuY29tcG9uZW50Lmxlc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGltZXRhYmxlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zIDogU3Vic2NyaXB0aW9uW10gPSBbXTtcclxuICAgIFxyXG4gICAgYnJlYWtQZXJpb2RMYWJlbCA9IFwiXCI7XHJcbiAgICBob21ld29ya0ljb24gPSBcIlwiO1xyXG5cclxuICAgIGxvZ2dlZEluVXNlcjogVXNlcjtcclxuICAgIFxyXG4gICAgbGVzc29uRGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICBzdGFydERhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgZW5kRGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgYWxsSG9tZXdvcmtzOiBIb21ld29ya1tdID0gW107XHJcbiAgICBhbGxEdWVIb21ld29ya3M6IEhvbWV3b3JrW10gPSBbXTtcclxuXHJcbiAgICBhbGxMZXNzb25zOiBMZXNzb25bXSA9IFtdO1xyXG4gICAgbGVzc29uc0ZvckRhdGU6IExlc3NvbltdID0gW107XHJcblxyXG4gICAgYWxsUGVyaW9kczogUGVyaW9kW10gPSBbXTtcclxuICAgIHBlcmlvZHNGb3JEYXRlOiBQZXJpb2RbXSA9IFtdOyAgICBcclxuXHJcbiAgICB0YWJEYXRlczogVGltZXRhYmxlVGFiW10gPSBbXTtcclxuICAgIFxyXG4gICAgY3VycmVudCA9IGZhbHNlO1xyXG4gICAgaGFzTGVzc29uID0gdHJ1ZTtcclxuICAgIGlzRHVlTGVzc29uID0gZmFsc2U7XHJcbiAgICBpc0xvYWRpbmcgPSB0cnVlO1xyXG4gICAgbGFzdExlc3NvbiA9IGZhbHNlO1xyXG4gICAgc2hvd0RldGFpbHMgPSBmYWxzZTtcclxuICAgIFxyXG4gICAgZGF0ZVJhbmdlID0gW107XHJcbiAgICB0YWJTZWxlY3RlZEluZGV4OiBudW1iZXI7XHJcbiAgICAgICAgICAgXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGFwcFZhbHVlc1NlcnZpY2U6IEFwcFZhbHVlc1NlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBob21ld29ya1NlcnZpY2U6IEhvbWV3b3JrU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGxvZ2dpbmdTZXJ2aWNlOiBMb2dnaW5nU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxyXG4gICAgICAgIHByaXZhdGUgdGltZXRhYmxlU2VydmljZTogVGltZXRhYmxlU2VydmljZSxcclxuICAgICkgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKSB7IFxyXG4gICAgICAgIHRoaXMubG9nZ2VkSW5Vc2VyID0gdGhpcy5hcHBWYWx1ZXNTZXJ2aWNlLmdldExvZ2dlZEluVXNlcigpO1xyXG5cclxuICAgICAgICB0aGlzLnN0YXJ0RGF0ZS5zZXREYXRlKHRoaXMuc3RhcnREYXRlLmdldERhdGUoKSAtICh0aGlzLnN0YXJ0RGF0ZS5nZXREYXkoKSArIDcpKTtcclxuICAgICAgICB0aGlzLmVuZERhdGUuc2V0RGF0ZSh0aGlzLmVuZERhdGUuZ2V0RGF0ZSgpIC0gKHRoaXMuZW5kRGF0ZS5nZXREYXkoKSAtIDE0KSk7XHJcblxyXG4gICAgICAgIHRoaXMuZ2V0QWxsSG9tZXdvcmsoKTtcclxuICAgICAgICB0aGlzLmdldExlc3NvbnNEYXRlUmFuZ2UoKTtcclxuICAgICAgICB0aGlzLmdldExlc3NvbnMoKTtcclxuICAgICAgICB0aGlzLmdldFBlcmlvZHMoKTsgICAgICAgIFxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbnMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgc3Vic2NyaXB0aW9uIG9mIHRoaXMuc3Vic2NyaXB0aW9ucylcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWxsSG9tZXdvcmsoKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5ob21ld29ya1NlcnZpY2UuZ2V0U3R1ZGVudEhvbWV3b3JrKHRoaXMubG9nZ2VkSW5Vc2VyLmlkKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgaG9tZXdvcmsgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsSG9tZXdvcmtzID0gaG9tZXdvcms7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICApXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QnJlYWtQZXJpb2QobGVzc29uOiBMZXNzb24pOiBib29sZWFuIHsgICAgXHJcbiAgICAgICAgbGV0IGJyZWFrVGltZU5hbWUgPSBCcmVhaztcclxuXHJcbiAgICAgICAgdGhpcy5icmVha1BlcmlvZExhYmVsID0gXCJcIjtcclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHJlZ2V4cCA9IG5ldyBSZWdFeHAoJ0InKTtcclxuICAgICAgICBjb25zdCBuYW1lID0gdGhpcy5nZXRQZXJpb2ROYW1lRm9yTGVzc29uKGxlc3Nvbik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKChuZXcgRGF0ZShsZXNzb24uc3RhcnREYXRlKS5nZXRIb3VycygpIDwgMTIpICYmIHJlZ2V4cC50ZXN0KG5hbWUpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYnJlYWtQZXJpb2RMYWJlbCA9IGJyZWFrVGltZU5hbWUuYW1CcmVhaztcclxuICAgICAgICAgICAgdGhpcy5zaG93RGV0YWlscyA9IGZhbHNlO1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9IFxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICgobmV3IERhdGUobGVzc29uLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKSA+PSAxMikgJiYgcmVnZXhwLnRlc3QobmFtZSkpIHtcclxuICAgICAgICAgICAgdGhpcy5icmVha1BlcmlvZExhYmVsID0gYnJlYWtUaW1lTmFtZS5wbUJyZWFrO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dEZXRhaWxzID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICB0aGlzLnNob3dEZXRhaWxzID10cnVlO1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDdXJyZW50TGVzc29uKGxlc3NvbjogTGVzc29uKTogYm9vbGVhbiB7XHJcbiAgICAgICAgbGV0IHRvZGF5ID0gbmV3IERhdGUoKTtcclxuXHJcbiAgICAgICAgaWYgKCh0b2RheSA+PSBuZXcgRGF0ZShsZXNzb24uc3RhcnREYXRlKSkgJiYgKHRvZGF5IDw9IG5ldyBEYXRlKGxlc3Nvbi5lbmREYXRlKSkpIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50ID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0SG9tZXdvcmtEdWVEYXRlKGxlc3NvbjogTGVzc29uKTogYm9vbGVhbiB7XHJcbiAgICAgICAgY29uc3QgZHVlSG9tZXdvcmsgPSB0aGlzLmFsbEhvbWV3b3Jrcy5maW5kKGggPT5cclxuICAgICAgICAgICAgaC5zdWJqZWN0ID09IGxlc3Nvbi5zdWJqZWN0XHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKGR1ZUhvbWV3b3JrICE9IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICB0aGlzLmFsbER1ZUhvbWV3b3Jrcy5wdXNoKGR1ZUhvbWV3b3JrKTtcclxuICAgICAgICAgICAgbGV0IGlzRHVlID0gdGhpcy5ob21ld29ya1NlcnZpY2UuaXNEdWUoZHVlSG9tZXdvcmspXHJcblxyXG4gICAgICAgICAgICBpZiAoaXNEdWUgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaXNEdWVMZXNzb24gPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ob21ld29ya0ljb24gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDB4ZTkxZik7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlc3NvbnMoKSB7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy50aW1ldGFibGVTZXJ2aWNlLmdldExlc3NvbnMoKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgbGVzc29ucyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGVzc29ucyA9IGxlc3NvbnMuc29ydCAoKG9iajE6IExlc3Nvbiwgb2JqMjogTGVzc29uKSAgPT5cclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShvYmoxLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKSAtIG5ldyBEYXRlKG9iajIuc3RhcnREYXRlKS5nZXRIb3VycygpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYWxsTGVzc29ucyA9IGxlc3NvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgLy90aGlzLmdldExlc3NvbnNGb3JEYXRlKHRoaXMubGVzc29uRGF0ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXRUYWJEYXRlTGVzc29uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4Kys7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRMZXNzb25zRGF0ZVJhbmdlKCkge1xyXG4gICAgICAgIC8vIG9uZSB3ZWVrIHByZXZpb3VzIGRhdGVcclxuICAgICAgICBsZXQgbWluRGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgbWluRGF0ZS5zZXREYXRlKG1pbkRhdGUuZ2V0RGF0ZSgpIC0gKG1pbkRhdGUuZ2V0RGF5KCkgKyA3KSk7XHJcblxyXG4gICAgICAgIC8vIHR3byB3ZWVrcyBmdXR1cmUgZGF0ZVxyXG4gICAgICAgIGxldCBtYXhEYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgICBtYXhEYXRlLnNldERhdGUobWF4RGF0ZS5nZXREYXRlKCkgLSAobWF4RGF0ZS5nZXREYXkoKSAtIDEzKSk7XHJcbiAgICAgICAgICAgICAgICBcclxuICAgICAgICBsZXQgdGFiSXRlbURhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgdGFiSXRlbURhdGUgPSBuZXcgRGF0ZShtaW5EYXRlLnNldERhdGUobWluRGF0ZS5nZXREYXRlKCkgKyAxKSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0ZVJhbmdlLnB1c2godGFiSXRlbURhdGUpO1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKHRhYkl0ZW1EYXRlLmdldERhdGUoKSA9PT0gdGhpcy5sZXNzb25EYXRlLmdldERhdGUoKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gdGhpcy5kYXRlUmFuZ2UuZmluZEluZGV4KHggPT4geCA9PSB0YWJJdGVtRGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IHdoaWxlICh0YWJJdGVtRGF0ZSA8IG1heERhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExlc3NvbnNGb3JEYXRlKGRhdGU6IERhdGUpIHtcclxuICAgICAgICBpZiAoIXRoaXMuYWxsTGVzc29ucykge1xyXG4gICAgICAgICAgICB0aGlzLmxlc3NvbnNGb3JEYXRlID0gW107XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5sZXNzb25zRm9yRGF0ZSA9IHRoaXMuYWxsTGVzc29ucy5maWx0ZXIobCA9PiBuZXcgRGF0ZShsLnN0YXJ0RGF0ZSkudG9EYXRlU3RyaW5nKCkgPT09IGRhdGUudG9EYXRlU3RyaW5nKCkpO1xyXG4gICAgICAgIHRoaXMuZ2V0VG90YWxMZXNzb24oKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQZXJpb2RzKCkge1xyXG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgICB0aGlzLnRpbWV0YWJsZVNlcnZpY2UuZ2V0UGVyaW9kcyhuZXcgRGF0ZSh0aGlzLnN0YXJ0RGF0ZSksIG5ldyBEYXRlKHRoaXMuZW5kRGF0ZSkpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKHAgPT4geyBcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFsbFBlcmlvZHMgPSBwO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBlcmlvZE5hbWVGb3JMZXNzb24obGVzc29uOiBMZXNzb24pOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBuYW1lID0gXCJcIjtcclxuXHJcbiAgICAgICAgY29uc3Qgc3RhcnRMZXNzb25EYXkgPSBuZXcgRGF0ZShsZXNzb24uc3RhcnREYXRlKS5nZXREYXkoKTtcclxuICAgICAgICBjb25zdCBzdGFydExlc3NvbkhvdXIgPSBuZXcgRGF0ZShsZXNzb24uc3RhcnREYXRlKS5nZXRIb3VycygpO1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0TGVzc29uTWludXRlID0gbmV3IERhdGUobGVzc29uLnN0YXJ0RGF0ZSkuZ2V0TWludXRlcygpO1xyXG4gICAgICAgIGNvbnN0IGVuZExlc3NvbkRheSA9IG5ldyBEYXRlKGxlc3Nvbi5lbmREYXRlKS5nZXREYXkoKTtcclxuICAgICAgICBjb25zdCBlbmRMZXNzb25Ib3VyID0gbmV3IERhdGUobGVzc29uLmVuZERhdGUpLmdldEhvdXJzKCk7XHJcbiAgICAgICAgY29uc3QgZW5kTGVzc29uTWludXRlID0gbmV3IERhdGUobGVzc29uLmVuZERhdGUpLmdldE1pbnV0ZXMoKTtcclxuXHJcbiAgICAgICAgY29uc3QgcGVyaW9kID0gdGhpcy5hbGxQZXJpb2RzLmZpbmQocCA9PiBcclxuICAgICAgICAgICAgbmV3IERhdGUocC5zdGFydERhdGUpLmdldERheSgpID09IHN0YXJ0TGVzc29uRGF5ICYmIFxyXG4gICAgICAgICAgICBuZXcgRGF0ZShwLnN0YXJ0RGF0ZSkuZ2V0SG91cnMoKSA9PSBzdGFydExlc3NvbkhvdXIgJiYgXHJcbiAgICAgICAgICAgIG5ldyBEYXRlKHAuc3RhcnREYXRlKS5nZXRNaW51dGVzKCkgPT0gc3RhcnRMZXNzb25NaW51dGUgJiYgXHJcbiAgICAgICAgICAgIG5ldyBEYXRlKHAuZW5kRGF0ZSkuZ2V0RGF5KCkgPT0gZW5kTGVzc29uRGF5ICYmIFxyXG4gICAgICAgICAgICBuZXcgRGF0ZShwLmVuZERhdGUpLmdldEhvdXJzKCkgPT0gZW5kTGVzc29uSG91ciAmJiBcclxuICAgICAgICAgICAgbmV3IERhdGUocC5lbmREYXRlKS5nZXRNaW51dGVzKCkgPT0gZW5kTGVzc29uTWludXRlXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHBlcmlvZCl7XHJcbiAgICAgICAgICAgIG5hbWUgPSBwZXJpb2QubmFtZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmV0dXJuIG5hbWU7XHJcbiAgICB9ICBcclxuXHJcbiAgICBnZXRTdWJqZWN0Q29sb3VyKGxlc3NvbjogTGVzc29uKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgc3ViamVjdCA9IFN1YmplY3Q7XHJcbiAgICAgICAgbGV0IGNvbG9yID0gXCJcIjtcclxuXHJcbiAgICAgICAgc3dpdGNoIChsZXNzb24uc3ViamVjdCkge1xyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QuYXJ0OiB7XHJcbiAgICAgICAgICAgICAgICBjb2xvciA9IFwiIzhCMDAwMFwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FzZSBzdWJqZWN0LmNvbXB1dGluZzoge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiM4QjQ1MTNcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5kZXNpZ246IHtcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gXCIjODA4MDAwXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QuZW5nbGlzaDoge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiMyRUNDRkFcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5nZW9ncmFwaHk6IHtcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gXCIjRkE1OEY0XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QuaGlzdG9yeToge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiMwNEI0MDRcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5sYW5ndWFnZXM6IHtcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gXCIjQkYwMEZGXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3QubWF0aDoge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiNGRjgwMDBcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5tdXNpYzoge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiM2NDJFRkVcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5wZToge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiNGRkZGMDBcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhc2Ugc3ViamVjdC5yZWc6IHtcclxuICAgICAgICAgICAgICAgIGNvbG9yID0gXCIjMDg2QTg3XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlIHN1YmplY3Quc2NpZW5jZToge1xyXG4gICAgICAgICAgICAgICAgY29sb3IgPSBcIiNGRjAwMDBcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY29sb3I7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VGFiRGF0ZUxlc3NvbigpIHtcclxuICAgICAgICBmb3IgKGxldCB0YWJEYXRlIG9mIHRoaXMuZGF0ZVJhbmdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ2V0TGVzc29uc0ZvckRhdGUodGFiRGF0ZSk7XHJcbiAgICAgICAgICAgIGxldCB0aW1ldGFibGVUYWIgPSBuZXcgVGltZXRhYmxlVGFiO1xyXG5cclxuICAgICAgICAgICAgdGltZXRhYmxlVGFiLmRhdGUgPSB0YWJEYXRlO1xyXG4gICAgICAgICAgICB0aW1ldGFibGVUYWIubGVzc29ucyA9IHRoaXMubGVzc29uc0ZvckRhdGU7XHJcbiAgICAgICAgICAgIHRoaXMudGFiRGF0ZXMucHVzaCh0aW1ldGFibGVUYWIpO1xyXG5cclxuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy50YWJEYXRlcyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaW50VGFiRGF0ZXMoKSB7XHJcbiAgICAgICAgbGV0IGN0ciA9IDA7XHJcbiAgICAgICAgZm9yIChsZXQgdGFiIG9mIHRoaXMudGFiRGF0ZXMpIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0NsYXNzOiAnICsgdGFiLmxlc3NvbnNbY3RyXS5jbGFzcyArICcgIFRlYWNoZXI6ICcgKyB0YWIubGVzc29uc1tjdHJdLnRlYWNoZXIpO1xyXG4gICAgICAgICAgICBjdHIrKztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0VG90YWxMZXNzb24oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMubGVzc29uc0ZvckRhdGUubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaGFzTGVzc29uID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmhhc0xlc3NvbiA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uVGFiU3dpcGUoYXJnczogU2VsZWN0ZWRJbmRleENoYW5nZWRFdmVudERhdGEpIHsgICAgICAgIFxyXG4gICAgICAgIGlmIChhcmdzLm9sZEluZGV4ICE9PSAtMSkge1xyXG4gICAgICAgICAgICAvL3RoaXMuZ2V0TGVzc29uc0ZvckRhdGUodGhpcy50YWJEYXRlW2FyZ3MubmV3SW5kZXhdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb25UYXBIb21ld29yayhsZXNzb246IExlc3Nvbikge1xyXG4gICAgICAgIGNvbnN0IGhvbWV3b3JrID0gdGhpcy5hbGxEdWVIb21ld29ya3MuZmluZChoID0+XHJcbiAgICAgICAgICAgIGguc3ViamVjdCA9PSBsZXNzb24uc3ViamVjdFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtgL2hvbWV3b3JrZGV0YWlscy8ke2hvbWV3b3JrLmlkfWBdKTtcclxuICAgIH1cclxufSJdfQ==